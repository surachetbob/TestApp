import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Layout
st.set_page_config(page_title="PA Insurance Calculator", layout="centered")

# ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets
conn = st.connection("gsheets", type=GSheetsConnection)

# CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á UI
st.markdown("""
    <style>
    div.stButton > button:first-child {
        width: 100%; height: 50px; font-size: 20px; border-radius: 10px;
        background-color: #ff4b4b; color: white;
    }
    .main { padding: 10px; }
    .premium-box {
        background-color:#f0f2f6; padding:20px; border-radius:10px; 
        text-align:center; border: 1px solid #ddd; margin-bottom: 20px;
    }
    </style>
    """, unsafe_allow_html=True)

# --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
PLAN_BENEFITS = {
    "AIANPA2500": {
        "‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/‡∏ó‡∏∏‡∏û‡∏û‡∏•‡∏†‡∏≤‡∏û (AD,DD,PD)": "500,000",
        "‡∏Ü‡∏≤‡∏ï‡∏Å‡∏£‡∏£‡∏°/‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢ (MA)": "250,000",
        "‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà/‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå (MC)": "250,000",
        "‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (ME)": "20,000",
        "‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏ï‡∏Å‡∏´‡∏±‡∏Å (BB)": "10,000",
        "‡∏Ñ‡πà‡∏≤‡∏õ‡∏•‡∏á‡∏®‡∏û (CM)": "10,000",
        "‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô": "15 ‡∏ß‡∏±‡∏ô - 70 ‡∏õ‡∏µ"
    },
    "AIANPA3000": {
        "‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/‡∏ó‡∏∏‡∏û‡∏û‡∏•‡∏†‡∏≤‡∏û (AD,DD,PD)": "600,000",
        "‡∏Ü‡∏≤‡∏ï‡∏Å‡∏£‡∏£‡∏°/‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢ (MA)": "300,000",
        "‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà/‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå (MC)": "600,000",
        "‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (ME)": "35,000",
        "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (PH)": "600,000",
        "‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏ï‡∏Å‡∏´‡∏±‡∏Å (BB)": "2,000",
        "‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô": "15 ‡∏ß‡∏±‡∏ô - 74 ‡∏õ‡∏µ"
    },
    "AIANPA3800": {
        "‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/‡∏ó‡∏∏‡∏û‡∏û‡∏•‡∏†‡∏≤‡∏û (AD,DD,PD)": "500,000",
        "‡∏Ü‡∏≤‡∏ï‡∏Å‡∏£‡∏£‡∏°/‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢ (MA)": "250,000",
        "‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà/‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå (MC)": "250,000",
        "‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (ME)": "50,000",
        "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PP)": "1,050,000",
        "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (PH)": "500,000",
        "‡∏†‡∏±‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (ND)": "500,000",
        "‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (HU)": "500 (‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô)",
        "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏î‡∏π‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (FCG)": "1,000 (60 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)",
        "‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô": "16 - 60 ‡∏õ‡∏µ"
    }
}

def get_premium(plan, age):
    if plan == "AIANPA2500":
        if age <= 60: return 2500
        elif age <= 65: return 2700
        elif age <= 70: return 3150
        elif age <= 75: return 4000
    elif plan == "AIANPA3000":
        if age <= 60: return 3000
        elif age <= 65: return 3250
        elif age <= 70: return 3750
        elif age <= 75: return 4700
    elif plan == "AIANPA3800":
        if age <= 60: return 3800
        elif age <= 65: return 4600
        elif age <= 70: return 5300
        elif age <= 75: return 6770
    return None

# --- ‡∏™‡πà‡∏ß‡∏ô UI ‡∏´‡∏•‡∏±‡∏Å ---
st.title("üõ°Ô∏è‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á")
st.write("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•")

# 1. ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)
with st.expander("üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô", expanded=True):
    c1, c2 = st.columns(2)
    with c1:
        age = st.number_input("‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)", min_value=0, max_value=75, value=25)
    with c2:
        gender = st.selectbox("‡πÄ‡∏û‡∏®", ["‡∏ä‡∏≤‡∏¢", "‡∏´‡∏ç‡∏¥‡∏á"])
    plan_choice = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢", list(PLAN_BENEFITS.keys()))
    calculate_submit = st.button("üöÄ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô")

# ‡πÉ‡∏ä‡πâ Session State ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
if calculate_submit or 'calculated' in st.session_state:
    st.session_state.calculated = True
    st.divider()
    
    premium = get_premium(plan_choice, age)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
    st.markdown(f"""
        <div class="premium-box">
            <h3 style="margin:0;">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
            <h1 style="color:#ff4b4b; margin:0;">{premium:,} ‡∏ö‡∏≤‡∏ó</h1>
            <p style="color:#555;">‡πÅ‡∏ú‡∏ô: {plan_choice} | ‡∏≠‡∏≤‡∏¢‡∏∏: {age} ‡∏õ‡∏µ</p>
        </div>
    """, unsafe_allow_html=True)

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏≤‡∏¢‡∏∏
    if plan_choice == "AIANPA3800" and age < 16:
        st.error("‚ö†Ô∏è ‡πÅ‡∏ú‡∏ô AIANPA3800 ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏¢‡∏∏ 16 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô")

    # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á
    st.subheader(f"üìã ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á {plan_choice}")
    benefits = PLAN_BENEFITS[plan_choice]
    benefit_data = [{"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": k, "‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)": v} for k, v in benefits.items()]
    st.dataframe(benefit_data, use_container_width=True, hide_index=True)

    # 2. ‡∏™‡πà‡∏ß‡∏ô "‡∏™‡∏ô‡πÉ‡∏à" (‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß)
    st.divider()
    st.subheader("üéØ ‡∏™‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö?")
    
    with st.form(key="lead_form"):
        name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠")
        phone = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", placeholder="08XXXXXXXX", max_chars=10)
        interest_submit = st.form_submit_button("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö")

        if interest_submit:
            if not name or len(phone) < 10 or not phone.isdigit():
                st.error("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
            else:
                try:
                    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheets
                    new_data = pd.DataFrame([{
                        "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": name,
                        "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£": phone,
                        "‡∏≠‡∏≤‡∏¢‡∏∏": age,
                        "‡πÄ‡∏û‡∏®": gender,
                        "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å": plan_choice,
                        "‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô": premium
                    }])
                    
                    existing_data = conn.read(worksheet="Sheet1", ttl=0)
                    updated_df = pd.concat([existing_data, new_data], ignore_index=True)
                    conn.update(worksheet="Sheet1", data=updated_df)
                    
                    st.success(f"‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {name} ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå {phone} ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î")
                    st.balloons()
                except Exception as e:
                    st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}")

    st.info("üìû **‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏î‡πà‡∏ß‡∏ô:** ‡∏°‡∏µ‡∏ô ‡πÇ‡∏ó‡∏£ 086-5348448")

else:
    st.info("üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î")
