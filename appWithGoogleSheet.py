import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="Health Insurance Calculator", layout="centered")

# ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
conn = st.connection("gsheets", type=GSheetsConnection)

# CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI
st.markdown("""
    <style>
    div.stButton > button:first-child {
        width: 100%; height: 55px; font-size: 1.2rem; border-radius: 12px;
        background-color: #e91e63; color: white; border: none;
    }
    .stMetric { background-color: #fff0f5; padding: 15px; border-radius: 10px; }
    .detail-card {
        padding: 20px; border-radius: 10px; background-color: #f8f9fa;
        border-left: 5px solid #e91e63; margin-bottom: 10px;
    }
    </style>
    """, unsafe_allow_html=True)

# --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (PREMIUM_DATA) ---
PREMIUM_DATA = {
    "‡∏ä‡∏≤‡∏¢": {
        "‡πÅ‡∏ú‡∏ô 1 (1 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 16400), (16, 20, 13500), (21, 25, 13700), (26, 30, 14700), (31, 35, 15100), (36, 40, 17000), (41, 45, 19200), (46, 50, 21600), (51, 55, 28300), (56, 59, 34100), (60, 65, 40900), (66, 70, 59400), (71, 75, 85400), (76, 80, 122900), (81, 85, 177800), (86, 90, 204500), (91, 95, 235200), (96, 98, 270500)],
        "‡πÅ‡∏ú‡∏ô 2 (5 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 20200), (16, 20, 16500), (21, 25, 16900), (26, 30, 18300), (31, 35, 18900), (36, 40, 20800), (41, 45, 23800), (46, 50, 26700), (51, 55, 35000), (56, 59, 42300), (60, 65, 50600), (66, 70, 72100), (71, 75, 104000), (76, 80, 150000), (81, 85, 217100), (86, 90, 249700), (91, 95, 287200), (96, 98, 330300)],
        "‡πÅ‡∏ú‡∏ô 3 (15 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 25500), (16, 20, 20100), (21, 25, 21600), (26, 30, 26100), (31, 35, 29400), (36, 40, 31800), (41, 45, 36000), (46, 50, 40200), (51, 55, 50100), (56, 59, 63900), (60, 65, 72300), (66, 70, 105000), (71, 75, 152100), (76, 80, 219900), (81, 85, 318300), (86, 90, 366000), (91, 95, 420900), (96, 98, 484200)],
        "‡πÅ‡∏ú‡∏ô 4 (25 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 33400), (16, 20, 26200), (21, 25, 28000), (26, 30, 33800), (31, 35, 37800), (36, 40, 40900), (41, 45, 47300), (46, 50, 52400), (51, 55, 65300), (56, 59, 83000), (60, 65, 94100), (66, 70, 136700), (71, 75, 197800), (76, 80, 286300), (81, 85, 414700), (86, 90, 476900), (91, 95, 548400), (96, 98, 630700)]
    },
    "‡∏´‡∏ç‡∏¥‡∏á": {
        "‡πÅ‡∏ú‡∏ô 1 (1 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 14400), (16, 20, 15200), (21, 25, 17200), (26, 30, 17500), (31, 35, 18400), (36, 40, 20400), (41, 45, 22300), (46, 50, 24500), (51, 55, 28500), (56, 59, 34400), (60, 65, 41500), (66, 70, 60800), (71, 75, 88200), (76, 80, 126300), (81, 85, 182700), (86, 90, 210100), (91, 95, 241600), (96, 98, 277800)],
        "‡πÅ‡∏ú‡∏ô 2 (5 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 18200), (16, 20, 19100), (21, 25, 21500), (26, 30, 21800), (31, 35, 22700), (36, 40, 25100), (41, 45, 27800), (46, 50, 30400), (51, 55, 35200), (56, 59, 42500), (60, 65, 50800), (66, 70, 74000), (71, 75, 107500), (76, 80, 154400), (81, 85, 223400), (86, 90, 256900), (91, 95, 295400), (96, 98, 339700)],
        "‡πÅ‡∏ú‡∏ô 3 (15 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 21600), (16, 20, 23100), (21, 25, 27000), (26, 30, 30600), (31, 35, 34200), (36, 40, 37200), (41, 45, 42900), (46, 50, 46500), (51, 55, 50700), (56, 59, 65100), (60, 65, 73500), (66, 70, 107100), (71, 75, 155700), (76, 80, 224700), (81, 85, 325500), (86, 90, 374400), (91, 95, 430500), (96, 98, 495000)],
        "‡πÅ‡∏ú‡∏ô 4 (25 ‡∏•‡πâ‡∏≤‡∏ô)": [(11, 15, 27900), (16, 20, 30300), (21, 25, 35300), (26, 30, 38000), (31, 35, 42300), (36, 40, 46000), (41, 45, 53600), (46, 50, 60700), (51, 55, 65500), (56, 59, 84600), (60, 65, 95700), (66, 70, 139300), (71, 75, 202000), (76, 80, 291800), (81, 85, 422700), (86, 90, 486100), (91, 95, 559000), (96, 98, 642900)]
    }
}

PLAN_DETAILS = {
    "‡πÅ‡∏ú‡∏ô 1 (1 ‡∏•‡πâ‡∏≤‡∏ô)": {"room": "1,500", "doctor": "1,000", "medicine_return": "20,000", "opd": "‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á", "limit": "1,000,000"},
    "‡πÅ‡∏ú‡∏ô 2 (5 ‡∏•‡πâ‡∏≤‡∏ô)": {"room": "3,000", "doctor": "2,000", "medicine_return": "20,000", "opd": "‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á", "limit": "5,000,000"},
    "‡πÅ‡∏ú‡∏ô 3 (15 ‡∏•‡πâ‡∏≤‡∏ô)": {"room": "6,000", "doctor": "4,000", "medicine_return": "20,000", "opd": "‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á", "limit": "15,000,000"},
    "‡πÅ‡∏ú‡∏ô 4 (25 ‡∏•‡πâ‡∏≤‡∏ô)": {"room": "9,000", "doctor": "6,000", "medicine_return": "‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á", "opd": "2,000 ‡∏ö‡∏≤‡∏ó (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 30 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)", "limit": "25,000,000"}
}

def calculate_premium(gender, plan, age):
    gender_data = PREMIUM_DATA.get(gender, {})
    plan_data = gender_data.get(plan, [])
    for start_age, end_age, price in plan_data:
        if start_age <= age <= end_age:
            return price
    return None

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å ---
st.title("üìã ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û")
st.write("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á")

# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
with st.expander("üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏ô‡πÉ‡∏à‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô", expanded=True):
    name_input = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    phone_input = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678", max_chars=10)

with st.container():
    col1, col2 = st.columns(2)
    with col1:
        gender_input = st.selectbox("üöª ‡πÄ‡∏û‡∏®", ["‡∏ä‡∏≤‡∏¢", "‡∏´‡∏ç‡∏¥‡∏á"])
    with col2:
        age_input = st.number_input("üéÇ ‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)", min_value=11, max_value=98, value=30)
    
    plan_input = st.selectbox("üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢", list(PLAN_DETAILS.keys()))
    
    calculate_btn = st.button("üöÄ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")

if calculate_btn:
    if not name_input or len(phone_input) < 10:
        st.error("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")
    else:
        premium = calculate_premium(gender_input, plan_input, age_input)
        
        if premium:
            # --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ---
            try:
                new_lead = pd.DataFrame([{
                    "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "‡∏ä‡∏∑‡πà‡∏≠": name_input,
                    "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£": phone_input,
                    "‡πÄ‡∏û‡∏®": gender_input,
                    "‡∏≠‡∏≤‡∏¢‡∏∏": age_input,
                    "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å": plan_input,
                    "‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô": premium
                }])
                
                # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                existing_data = conn.read(worksheet="Sheet1", ttl=0)
                updated_df = pd.concat([existing_data, new_lead], ignore_index=True)
                conn.update(worksheet="Sheet1", data=updated_df)
                
                st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
                st.balloons()
            except Exception as e:
                st.warning(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Sheets): {e}")

            # --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á ---
            st.divider()
            st.metric(label=f"‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ ‡∏Ñ‡∏∏‡∏ì {name_input}", value=f"{premium:,} ‡∏ö‡∏≤‡∏ó")
            
            details = PLAN_DETAILS[plan_input]
            st.subheader("üõ°Ô∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å")
            
            c1, c2 = st.columns(2)
            with c1:
                st.markdown(f'<div class="detail-card"><b>üè• ‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</b><br>{details["room"]} / ‡∏ß‡∏±‡∏ô</div>', unsafe_allow_html=True)
                st.markdown(f'<div class="detail-card"><b>ü©∫ ‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏≠</b><br>{details["doctor"]} / ‡∏ß‡∏±‡∏ô</div>', unsafe_allow_html=True)
            with c2:
                st.markdown(f'<div class="detail-card"><b>üíä ‡∏¢‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</b><br>{details["medicine_return"]}</div>', unsafe_allow_html=True)
                st.markdown(f'<div class="detail-card"><b>üöë ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</b><br>{details["limit"]} ‡∏ö‡∏≤‡∏ó</div>', unsafe_allow_html=True)

            with st.expander("üîç ‡∏î‡∏π‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"):
                st.write("* ‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ï/‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î: ‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á")
                st.write("* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô 2 ‡πÄ‡∏ó‡πà‡∏≤")
        else:
            st.error("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡∏µ‡πâ")

st.info("üìû **‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:** ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏°‡∏µ‡∏ô ‡πÇ‡∏ó‡∏£ 086-5348448")
